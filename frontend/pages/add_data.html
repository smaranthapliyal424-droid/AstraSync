<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AstraSync â€¢ Add Data</title>
  <link rel="manifest" href="../public/manifest.json">
  <link rel="stylesheet" href="css/style.css">
<meta name="theme-color" content="#0A84FF">
<link rel="apple-touch-icon" href="../public/assets/icon-192.png">

</head>
<body>
  <div class="shell" style="grid-template-columns:78px 1fr;">
    <aside class="sidebar">
      <div class="brand">AS</div>
      <a class="navIcon" href="index.html">ðŸ </a>
      <a class="navIcon active" href="add_data.html">âž•</a>
      <a class="navIcon" href="upload.html">ðŸ“„</a>
      <a class="navIcon" href="history.html">ðŸ“ˆ</a>
      <a class="navIcon" href="report.html">ðŸ§¾</a>
      <a class="navIcon" href="profile.html"><i class='fas fa-user-alt' style='font-size:36px'></i></a>
    </aside>

    <main class="main">
      <section class="header">
        <div>
          <h1 class="hTitle">Add Health Data</h1>
          <div class="hSub">Manual entry (works even without devices)</div>
        </div>
        <div class="hActions">
          <button class="btn secondary" onclick="enableAlerts()">Enable Alerts</button>
          <a class="btn" href="index.html" style="text-decoration:none;">Back</a>
        </div>
      </section>

      <div class="card">
        <h3 class="cardTitle">Todayâ€™s Entry</h3>

        <div class="formGrid">
          <div class="field"><label>Date</label><input id="date" type="date"/></div>
          <div class="field"><label>Steps</label><input id="steps" type="number" placeholder="5000"/></div>

          <div class="field"><label>Sleep Hours</label><input id="sleep_hours" type="number" step="0.1" placeholder="7.0"/></div>
          <div class="field"><label>SpOâ‚‚ Avg (%)</label><input id="spo2_avg" type="number" placeholder="97"/></div>

          <div class="field"><label>Resting HR (bpm)</label><input id="resting_hr" type="number" placeholder="72"/></div>
          <div class="field"><label>Water Intake (ml)</label><input id="water_ml" type="number" placeholder="2000"/></div>

          <div class="field"><label>BP Systolic</label><input id="bp_sys" type="number" placeholder="120"/></div>
          <div class="field"><label>BP Diastolic</label><input id="bp_dia" type="number" placeholder="80"/></div>

          <div class="field"><label>Screen Time (min)</label><input id="screen_time_min" type="number" placeholder="240"/></div>
          <div class="field"><label>Toilet Frequency</label><input id="toilet_freq" type="number" placeholder="5"/></div>
        </div>

        <div class="hr"></div>

        <div class="toggleRow">
          <label class="toggle"><input id="alcohol" type="checkbox"/><span>Alcohol</span></label>
          <label class="toggle"><input id="smoking" type="checkbox"/><span>Smoking</span></label>
        </div>

        <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
          <button class="btn" id="saveBtn">Save & Analyze</button>
          <a class="btn secondary" href="history.html" style="text-decoration:none;">View History</a>
          <button type="button" id="syncBtn">Sync from Google Fit</button>


        </div>

        <p class="muted" style="margin-top:10px">
          Tip: For better accuracy, use BP cuff readings and consistent times.
        </p>
      </div>

      <nav class="bottomNav">
        <a href="index.html">Dashboard</a>
        <a class="active" href="add_data.html">Add</a>
        <a href="upload.html">Upload</a>
        <a href="history.html">History</a>
        <a href="profile.html">Profile</a>
      </nav>
    </main>
  </div>

<script src="js/app.js"></script>
<script src="js/api.js"></script>

  <script>
document.getElementById("syncBtn").addEventListener("click", async () => {
  try {
    const data = await apiGet("/sync/google-fit");


    // Auto-fill date
    if (document.getElementById("date")) {
      document.getElementById("date").value = data.date;
    }

    // Auto-fill steps
    if (document.getElementById("steps")) {
      document.getElementById("steps").value = data.steps ?? 0;
    }

    // Map heart_rate_avg → resting_hr
    if (document.getElementById("resting_hr")) {
      document.getElementById("resting_hr").value = data.heart_rate_avg ?? 0;
    }

    // Optional fields (if backend later provides them)
    if (document.getElementById("sleep_hours") && data.sleep_hours) {
      document.getElementById("sleep_hours").value = data.sleep_hours;
    }

    if (document.getElementById("spo2_avg") && data.spo2_avg) {
      document.getElementById("spo2_avg").value = data.spo2_avg;
    }

    // Toilet frequency
    if (document.getElementById("toilet_freq")) {
      document.getElementById("toilet_freq").value = data.toilet_freq ?? 0;
    }

    // Toggle switches
    if (document.getElementById("alcohol")) {
      document.getElementById("alcohol").checked = data.alcohol === 1;
    }

    if (document.getElementById("smoking")) {
      document.getElementById("smoking").checked = data.smoking === 1;
    }

    alert("Google Fit data synced successfully.");

  } catch (err) {
    console.error(err);
    alert("Sync failed. Check backend.");
  }
});
</script>
<script>


  setActiveNav("add_data.html");
  if (!localStorage.getItem("astrasync_authed")) window.location.href = "login.html";

  const dateEl = document.getElementById("date");
  const saveBtn = document.getElementById("saveBtn");
  const num = (id) => Number(document.getElementById(id).value || 0);
  dateEl.value = todayISO();
  
  

  saveBtn.addEventListener("click", async () => {
    try {
      const entry = {
        user_id: "demo_user",
        date: dateEl.value || todayISO(),
        steps: num("steps"),
        sleep_hours: num("sleep_hours"),
        spo2_avg: num("spo2_avg"),
        resting_hr: num("resting_hr"),
        water_ml: num("water_ml"),
        bp_sys: num("bp_sys"),
        bp_dia: num("bp_dia"),
        screen_time_min: num("screen_time_min"),
        toilet_freq: num("toilet_freq"),
        alcohol: document.getElementById("alcohol").checked ? 1 : 0,
        smoking: document.getElementById("smoking").checked ? 1 : 0
      };

      const [, score] = await Promise.all([
        apiPost("/submit_data", entry),
        apiPost("/score", entry)
      ]);
      
      addLog(entry);
      localStorage.setItem("astrasync_last_score", JSON.stringify(score));

      const risk = score?.risk_color ?? score?.risk ?? "Unknown";
      const confidence = score?.confidence ?? score?.confidence_pct ?? "N/A";
      alert(`Saved Risk: ${risk} (${confidence}%)`);
      // window.location.href ="index.html";
      window.location.href = "history.html";
      
    } catch (err) {
      console.error(err);
      alert("Save failed. Check backend connection and try again.");
    }
  });
</script>
</body>
</html>

